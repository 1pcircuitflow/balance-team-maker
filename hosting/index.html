<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>참가 신청 - Balance Team Maker Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #020617;
            color: white;
            -webkit-tap-highlight-color: transparent;
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .pitch-container {
            position: relative;
            width: 100%;
            max-width: 280px;
            aspect-ratio: 3/4;
            margin: 0 auto;
        }

        .pitch-bg {
            position: absolute;
            inset: 0;
            border: 2px solid rgba(255, 255, 255, 0.05);
            /* overflow: hidden 제거 - 팝업 가려짐 방지 */
        }

        .node {
            position: absolute;
            transform: translate(-50%, -50%);
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: white;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        .node:active {
            scale: 0.9;
        }

        .node-label {
            font-size: 8px;
            line-height: 1;
            margin-top: 1px;
        }

        .menu-popup {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-12px);
            background: #1e293b;
            border-radius: 9999px;
            padding: 4px;
            display: flex;
            gap: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 100;
            animation: pop 0.2s ease-out;
        }

        .menu-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 900;
            color: white;
            transition: all 0.2s;
        }

        .menu-btn:active {
            scale: 0.8;
        }

        @keyframes pop {
            from {
                scale: 0.5;
                opacity: 0;
                transform: translateX(-50%) translateY(0);
            }

            to {
                scale: 1;
                opacity: 1;
                transform: translateX(-50%) translateY(-12px);
            }
        }

        /* Pitch Lines */
        .line {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.1);
            pointer-events: none;
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center justify-center p-4">
    <div id="loginSection" class="w-full hidden">
        <button id="loginBtn"
            class="w-full py-3 bg-white text-slate-900 font-bold rounded-2xl flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg border border-slate-200">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
            <span id="loginText">Google 로그인으로 정보 기억하기</span>
        </button>
        <div id="userInfo"
            class="hidden flex items-center justify-between bg-slate-800 rounded-2xl p-3 px-4 border border-slate-700">
            <div class="flex items-center gap-3">
                <img id="userPhoto" src="" class="w-8 h-8 rounded-full bg-slate-700" alt="Profile">
                <div class="flex flex-col text-left">
                    <span id="userName" class="text-xs font-bold text-slate-200">User</span>
                    <span class="text-[10px] text-slate-500">정보가 자동 저장됩니다</span>
                </div>
            </div>
            <button id="logoutBtn" class="text-[10px] text-slate-400 font-bold underline px-2 py-1">로그아웃</button>
        </div>
    </div>

    <div id="app" class="w-full max-w-[350px] space-y-4">
        <!-- 기존 내용 유지 -->
        <div class="text-center">
            <h1 class="text-3xl font-black tracking-tighter text-blue-500">Balance Team Maker</h1>
            <p class="text-slate-400 text-xs mt-1 font-bold uppercase tracking-widest">Smart Recruitment System v3.0</p>
        </div>

        <div id="loading" class="flex flex-col items-center gap-4 py-20">
            <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-slate-500 font-bold text-sm">운동장을 준비하고 있습니다...</p>
        </div>

        <div id="roomInfo" class="glass rounded-[2rem] p-5 space-y-1 hidden text-center">
            <h2 id="roomSport" class="text-xl font-black text-white">---</h2>
            <p id="roomDateTime" class="text-blue-400 font-black text-xs">---</p>
        </div>

        <div id="participantsInfo" class="glass rounded-[2rem] p-5 space-y-3 hidden">
            <div class="flex items-center justify-between">
                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">참가 현황</span>
                <span id="participantCount" class="text-xs font-black text-blue-400">0명</span>
            </div>
            <div id="participantList" class="flex flex-wrap gap-1.5">
                <!-- Participants injected here -->
            </div>

            <!-- Viral Banner for Belo (List view) -->
            <div class="mt-4 pt-4 border-t border-white/5">
                <a href="https://play.google.com/store/apps/details?id=com.balanceteammaker"
                    class="block p-4 rounded-2xl bg-gradient-to-br from-blue-600/20 to-purple-600/20 border border-blue-500/30 transition-all active:scale-[0.98] group relative overflow-hidden">
                    <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                    <div class="relative flex items-center justify-between">
                        <div>
                            <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest mb-1">Team Balance
                                Solution</p>
                            <h4 class="text-sm font-black text-white leading-tight">밸런스 팀 메이커 Belo로<br>오늘 경기도 공정하게!</h4>
                        </div>
                        <div
                            class="bg-blue-600 p-2 rounded-xl shadow-lg shadow-blue-900/40 group-hover:translate-x-1 transition-transform">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-white" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                            </svg>
                        </div>
                    </div>
                    <span class="block mt-2 text-[10px] font-bold text-slate-400">명단 확인부터 팀 나누기까지 한 번에 [앱 다운로드]</span>
                </a>
            </div>
        </div>

        <form id="applyForm" class="glass rounded-[2rem] p-5 space-y-5 hidden">
            <div>
                <label
                    class="block text-[10px] font-black text-slate-500 mb-2 uppercase tracking-widest ml-1">이름</label>
                <input type="text" id="name" required placeholder="본인의 이름을 입력하세요"
                    class="w-full bg-slate-900 border border-slate-800 rounded-2xl px-5 py-4 focus:outline-none focus:ring-2 focus:ring-blue-600 font-black text-white transition-all">
            </div>

            <div class="space-y-2">
                <label class="block text-[10px] font-black text-slate-500 mb-1 uppercase tracking-widest ml-1">실력
                    티어</label>
                <div class="grid grid-cols-5 gap-1.5" id="tierGroup">
                    <button type="button" data-tier="S"
                        class="tier-btn py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400 transition-all">S</button>
                    <button type="button" data-tier="A"
                        class="tier-btn py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400 transition-all">A</button>
                    <button type="button" data-tier="B"
                        class="tier-btn py-3 rounded-xl font-black text-xs bg-blue-600 text-white shadow-lg shadow-blue-900/40 transition-all">B</button>
                    <button type="button" data-tier="C"
                        class="tier-btn py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400 transition-all">C</button>
                    <button type="button" data-tier="D"
                        class="tier-btn py-3 rounded-xl font-black text-xs bg-slate-800 text-slate-400 transition-all">D</button>
                </div>
            </div>

            <div id="posSection" class="space-y-3">
                <label class="block text-[10px] font-black text-slate-500 mb-1 uppercase tracking-widest ml-1">포지션 선호도
                    (터치하여 선택)</label>
                <div class="pitch-container" id="pitch">
                    <div class="pitch-bg" id="pitchLines"></div>
                    <!-- Nodes will be injected here -->
                </div>
                <p class="text-center text-[10px] text-slate-500 italic font-bold">노드를 터치하여 100 / 75 / 50 / X 를 선택하세요
                </p>
            </div>

            <button type="submit" id="submitBtn"
                class="w-full py-5 bg-blue-600 text-white font-black rounded-3xl transition-all active:scale-95 shadow-xl shadow-blue-900/40 text-lg">
                참가 신청 완료
            </button>
        </form>

        <div id="success" class="glass rounded-[2.5rem] p-10 text-center space-y-6 hidden">
            <div class="text-6xl animate-bounce">✅</div>
            <h3 class="text-2xl font-black">신청 완료!</h3>
            <p class="text-slate-400 text-sm font-medium">방장님이 승인하면 팀 편성에 포함됩니다.<br>조금만 기다려주세요!</p>

            <div class="pt-4 border-t border-white/5 space-y-3">
                <p class="text-[10px] font-black text-blue-500 uppercase tracking-wider">Smart Viral Promotion</p>
                <a href="https://play.google.com/store/apps/details?id=com.balanceteammaker"
                    class="block w-full py-5 px-4 bg-gradient-to-r from-blue-600 to-blue-500 text-white font-black rounded-3xl shadow-xl shadow-blue-900/40 transition-all active:scale-95 leading-snug">
                    오늘 경기도 공정하게!<br>
                    <span class="text-xs opacity-90 font-bold">Belo로 팀 나누기 [앱 다운로드]</span>
                </a>
                <p class="text-[10px] text-slate-500 font-bold">방장님이 되시면 더 많은 기능을 쓸 수 있어요!</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, setDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCX43ePWFhdIbCUZUtoMePqMdTXiAowlx0",
            authDomain: "balance-team-maker.firebaseapp.com",
            projectId: "balance-team-maker",
            storageBucket: "balance-team-maker.firebasestorage.app",
            messagingSenderId: "834065889708",
            appId: "1:834065889708:web:0fb72121f685619d406209"
        };

        const POS_CONFIG = {
            'Soccer': [
                { id: 'GK', x: 50, y: 85 }, { id: 'LB', x: 15, y: 65 }, { id: 'DF', x: 50, y: 65 }, { id: 'RB', x: 85, y: 65 },
                { id: 'MF', x: 50, y: 42 }, { id: 'LW', x: 15, y: 25 }, { id: 'FW', x: 50, y: 18 }, { id: 'RW', x: 85, y: 25 }
            ],
            'Futsal': [
                { id: 'GK', x: 50, y: 82 }, { id: 'FIX', x: 50, y: 62 }, { id: 'ALA', x: 50, y: 40 }, { id: 'PIV', x: 50, y: 18 }
            ],
            'Basketball': [
                { id: 'PG', x: 35, y: 72 }, { id: 'SG', x: 65, y: 72 }, { id: 'SF', x: 25, y: 45 }, { id: 'PF', x: 75, y: 45 }, { id: 'C', x: 50, y: 28 }
            ]
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 로컬 스토리지 키
        const KEY_NAME = 'btm_user_name';
        const KEY_TIER = 'btm_user_tier';

        // Auth Logic
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const userInfo = document.getElementById('userInfo');
        const loginSection = document.getElementById('loginSection');

        // 초기 로컬 데이터 로드
        const localName = localStorage.getItem(KEY_NAME);
        const localTier = localStorage.getItem(KEY_TIER);
        if (localName) document.getElementById('name').value = localName;

        loginBtn.onclick = async () => {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed", error);
            }
        };

        logoutBtn.onclick = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (loginSection) loginSection.classList.remove('hidden');
            if (user) {
                if (loginBtn) loginBtn.classList.add('hidden');
                if (userInfo) userInfo.classList.remove('hidden');
                const photoEl = document.getElementById('userPhoto');
                const nameEl = document.getElementById('userName');
                if (photoEl) photoEl.src = user.photoURL || '';
                if (nameEl) nameEl.textContent = user.displayName;

                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        const data = userDoc.data();
                        if (data.nickname) document.getElementById('name').value = data.nickname;
                        if (data.tier) selectTier(data.tier);
                    } else if (!document.getElementById('name').value && user.displayName) {
                        document.getElementById('name').value = user.displayName;
                    }
                } catch (e) {
                    console.error("User data fetch failed", e);
                }
            } else {
                if (loginBtn) loginBtn.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
            }
        });

        function selectTier(tier) {
            selectedTier = tier;
            document.querySelectorAll('.tier-btn').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
                b.classList.add('bg-slate-800', 'text-slate-400');
                if (b.dataset.tier === tier) {
                    b.classList.add('bg-blue-600', 'text-white', 'shadow-lg', 'shadow-blue-900/40');
                    b.classList.remove('bg-slate-800', 'text-slate-400');
                }
            });
        }

        const L = {
            en: {
                title: "Balance Team Maker",
                tagline: "Smart Matchmaking System",
                host: "Host",
                participants: "Status",
                name: "Name",
                namePlaceholder: "Enter your name",
                tier: "Skill Tier",
                position: "Primary Position",
                submit: "Apply Now",
                waiting: "Join Waiting List",
                successTitle: "Success!",
                successMsg: "Your application is submitted. Please wait for the host's approval.",
                loading: "Loading information...",
                invalid: "Invalid link.",
                expired: "Room not found or expired.",
                full: "Recruitment Closed (Join Waiting List)",
                closed: "Finished",
                recruiting: "Recruiting",
                list: "Applicant List",
                noList: "No applicants yet.",
                pos_fw: "Forward (FW)", pos_mf: "Midfielder (MF)", pos_df: "Defender (DF)", pos_gk: "Goalkeeper (GK)",
                pos_pg: "Point Guard (PG)", pos_sg: "Shooting Guard (SG)", pos_sf: "Small Forward (SF)", pos_pf: "Power Forward (PF)", pos_c: "Center (C)",
                loginText: "Remember Info with Google",
                logout: "Sign Out",
                autoSave: "Info auto-saved"
            },
            ko: {
                title: "Balance Team Maker",
                tagline: "스마트 참가 신청 시스템",
                host: "방장",
                participants: "인원 현황",
                name: "이름",
                namePlaceholder: "본인의 이름을 입력하세요",
                tier: "실력 티어",
                position: "주 포지션",
                submit: "참가 신청하기",
                waiting: "대기자 신청하기",
                successTitle: "신청 완료!",
                successMsg: "팀 편성이 완료되면 알려드릴게요. 방장의 승인을 기다려주세요.",
                loading: "정보를 불러오고 있습니다...",
                invalid: "유효하지 않은 링크입니다.",
                expired: "만료되었거나 존재하지 않는 방입니다.",
                full: "모집 마감 (대기자 신청)",
                closed: "마감됨",
                recruiting: "모집중",
                list: "참가자 목록",
                noList: "아직 신청자가 없습니다.",
                pos_fw: "포워드 (FW)", pos_mf: "미드필더 (MF)", pos_df: "수비수 (DF)", pos_gk: "골키퍼 (GK)",
                pos_pg: "포인트 가드 (PG)", pos_sg: "슈팅 가드 (SG)", pos_sf: "스몰 포워드 (SF)", pos_pf: "파워 포워드 (PF)", pos_c: "센터 (C)",
                loginText: "Google 로그인으로 정보 기억하기",
                logout: "로그아웃",
                autoSave: "정보가 자동 저장됩니다"
            }
        };

        const urlParams = new URLSearchParams(window.location.search);
        const langParam = urlParams.get('lang');
        const userLang = langParam && L[langParam] ? langParam : (navigator.language.startsWith('ko') ? 'ko' : 'en');
        const t = L[userLang];

        const roomId = urlParams.get('room');
        let currentSport = 'Soccer';
        let selections = {}; // { posId: 1 | 2 | 3 | 'X' }
        let selectedTier = 'B';
        let currentRoomData = null;

        if (localTier) selectTier(localTier);

        // 텍스트 일괄 적용
        document.querySelector('h1').textContent = t.title;
        document.querySelector('p.text-slate-400').textContent = t.tagline;
        if (document.getElementById('loading')) document.getElementById('loading').querySelector('p').textContent = t.loading;
        document.getElementById('name').placeholder = t.namePlaceholder;
        document.getElementById('tierGroup').previousElementSibling.textContent = t.tier;
        document.getElementById('submitBtn').textContent = t.submit;
        document.getElementById('success').querySelector('h3').textContent = t.successTitle;
        document.getElementById('success').querySelector('p').innerHTML = t.successMsg;
        document.getElementById('pitch').previousElementSibling.textContent = t.position;
        document.getElementById('loginText').textContent = t.loginText;
        document.getElementById('logoutBtn').textContent = t.logout;
        document.querySelector('#userInfo span.text-slate-500').textContent = t.autoSave;

        // 티어 선택 로직
        document.querySelectorAll('.tier-btn').forEach(btn => {
            btn.onclick = () => {
                selectTier(btn.dataset.tier);
            };
        });

        async function init() {
            try {
                if (!roomId) return;
                const docSnap = await getDoc(doc(db, "rooms", roomId));
                if (!docSnap.exists()) return;

                const data = docSnap.data();
                currentRoomData = data;

                const rawSport = data.sport || 'Soccer';
                currentSport = rawSport.charAt(0).toUpperCase() + rawSport.slice(1).toLowerCase();
                if (rawSport.toUpperCase() === 'SOCCER') currentSport = 'Soccer';
                if (rawSport.toUpperCase() === 'FUTSAL') currentSport = 'Futsal';
                if (rawSport.toUpperCase() === 'BASKETBALL') currentSport = 'Basketball';

                document.getElementById('roomSport').textContent = currentSport;
                document.getElementById('roomDateTime').textContent = `${data.matchDate} ${data.matchTime}`;

                if (data.sport === 'GENERAL' || data.sport === '일반' || data.sport === 'General') {
                    document.getElementById('posSection').classList.add('hidden');
                } else {
                    document.getElementById('posSection').classList.remove('hidden');
                    renderPitch();
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('roomInfo').classList.remove('hidden');
                document.getElementById('participantsInfo').classList.remove('hidden');
                document.getElementById('applyForm').classList.remove('hidden');

                renderParticipants(data.activeParticipants || data.applicants || []);
            } catch (err) {
                console.error("Init failed", err);
            }
        }

        function renderParticipants(participants) {
            const container = document.getElementById('participantList');
            const countEl = document.getElementById('participantCount');

            const approved = participants[0]?.isApproved !== undefined
                ? participants.filter(a => a.isApproved)
                : participants;

            countEl.textContent = `${approved.length}명`;

            if (approved.length === 0) {
                container.innerHTML = '<p class="text-[10px] text-slate-500 font-bold ml-1">아직 참가자가 없습니다.</p>';
                return;
            }

            container.innerHTML = approved.map(a => `
                <span class="inline-flex items-center px-2.5 py-1 rounded-lg bg-slate-800 border border-slate-700 text-[10px] font-bold text-slate-300">
                    ${a.name}
                </span>
            `).join('');
        }

        function renderPitch() {
            const container = document.getElementById('pitch');
            const lines = document.getElementById('pitchLines');
            const config = POS_CONFIG[currentSport] || POS_CONFIG['Soccer'];

            const existingNodes = container.querySelectorAll('.node');
            existingNodes.forEach(n => n.remove());

            if (currentSport === 'Basketball') {
                lines.innerHTML = `<div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/4 h-1/4 border-2 border-white/10"></div>
                                   <div class="absolute top-1/4 left-1/2 -translate-x-1/2 w-32 h-32 border-2 border-white/10 rounded-full"></div>`;
            } else if (currentSport === 'Futsal') {
                lines.innerHTML = `<div class="absolute top-1/2 left-0 right-0 h-px bg-white/20"></div>
                                   <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-16 h-16 border border-white/20 rounded-full"></div>
                                   <div class="absolute top-0 left-1/2 -translate-x-1/2 w-2/3 h-1/5 border-x border-b border-white/10"></div>
                                   <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-2/3 h-1/5 border-x border-t border-white/10"></div>`;
            } else {
                lines.innerHTML = `<div class="absolute top-1/2 left-0 right-0 h-px bg-white/10"></div>
                                   <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-20 h-20 border border-white/10 rounded-full"></div>
                                   <div class="absolute top-0 left-1/2 -translate-x-1/2 w-1/2 h-1/6 border-x border-b border-white/10"></div>
                                   <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-1/2 h-1/6 border-x border-t border-white/10"></div>`;
            }

            config.forEach(pos => {
                const node = document.createElement('div');
                node.className = 'node bg-slate-700';
                node.style.left = pos.x + '%';
                node.style.top = pos.y + '%';
                node.id = 'node-' + pos.id;
                node.innerHTML = `<span>${pos.id}</span><span class="node-label" id="label-${pos.id}"></span>`;

                node.onpointerdown = (e) => {
                    e.preventDefault();
                    showMenu(pos.id, node);
                };
                container.appendChild(node);
            });
        }

        function showMenu(posId, anchor) {
            document.querySelectorAll('.menu-popup').forEach(m => m.remove());
            document.querySelectorAll('.node').forEach(n => n.style.zIndex = "10");
            anchor.style.zIndex = "1000";

            const menu = document.createElement('div');
            menu.className = 'menu-popup';
            menu.onpointerdown = (e) => e.stopPropagation();
            menu.onmousedown = (e) => e.stopPropagation();

            const options = [
                { l: 1, v: '100', c: 'bg-emerald-500' },
                { l: 2, v: '75', c: 'bg-yellow-400' },
                { l: 3, v: '50', c: 'bg-orange-400' },
                { l: 'X', v: 'X', c: 'bg-rose-500' }
            ];

            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `menu-btn ${opt.c}`;
                btn.style.userSelect = 'none';
                btn.innerHTML = `<span style="pointer-events: none;">${opt.v}</span>`;
                btn.onpointerdown = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    selectPos(posId, opt);
                    menu.remove();
                };
                menu.appendChild(btn);
            });
            anchor.appendChild(menu);
        }

        function selectPos(posId, opt) {
            selections[posId] = opt.l;
            if (opt.l === 1 || opt.l === 2 || opt.l === 3) {
                const config = POS_CONFIG[currentSport] || POS_CONFIG['Soccer'];
                config.forEach(pos => {
                    const currentLevel = selections[pos.id];
                    if (pos.id !== posId && currentLevel !== 1 && currentLevel !== 2 && currentLevel !== 3) {
                        selections[pos.id] = 'X';
                        updateNodeUI(pos.id, { l: 'X', v: 'X', c: 'bg-rose-500' });
                    }
                });
            }
            updateNodeUI(posId, opt);
        }

        function updateNodeUI(posId, opt) {
            const node = document.getElementById('node-' + posId);
            const label = document.getElementById('label-' + posId);
            if (!node || !label) return;
            node.className = `node ${opt.c}`;
            label.textContent = opt.v;
        }

        document.getElementById('applyForm').onsubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value;
            const isGeneral = currentRoomData && (currentRoomData.sport === 'GENERAL' || currentRoomData.sport === '일반' || currentRoomData.sport === 'General');

            if (Object.keys(selections).length === 0 && !isGeneral) return alert('최소 하나 이상의 포지션 선호도를 선택해주세요.');

            localStorage.setItem(KEY_NAME, name);
            localStorage.setItem(KEY_TIER, selectedTier);

            const currentUser = auth.currentUser;
            if (currentUser) {
                try {
                    await setDoc(doc(db, "users", currentUser.uid), {
                        nickname: name,
                        tier: selectedTier
                    }, { merge: true });
                } catch (err) {
                    console.error("Failed to save user info to cloud", err);
                }
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '신청 중...';

            const p = [], s = [], t = [], f = [];
            Object.entries(selections).forEach(([pos, level]) => {
                if (level === 1) p.push(pos);
                else if (level === 2) s.push(pos);
                else if (level === 3) t.push(pos);
                else if (level === 'X') f.push(pos);
            });

            try {
                await updateDoc(doc(db, "rooms", roomId), {
                    applicants: arrayUnion({
                        id: Math.random().toString(36).substr(2, 9),
                        name,
                        tier: selectedTier,
                        position: p[0] || 'NONE',
                        primaryPositions: p,
                        secondaryPositions: s,
                        tertiaryPositions: t,
                        forbiddenPositions: f,
                        timestamp: new Date().toISOString()
                    })
                });
                document.getElementById('applyForm').classList.add('hidden');
                document.getElementById('success').classList.remove('hidden');
            } catch (err) {
                alert('신청 실패: ' + err.message);
                submitBtn.disabled = false;
            }
        };

        // 초기화 실행
        init();
    </script>
</body>

</html>